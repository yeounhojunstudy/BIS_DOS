<!doctype html>

<head>
    <meta charset="utf-8">
    <title>2316 연호준</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="main">
        <h1>버스 정보</h1>
        <p id="status" name="status" style="width:350px;;height:40px;">시작하기 버튼을 눌러 안내를 시작합니다.</p>
        <p id="result" name="result" style="color: #fff;;width: 350px;;height: 100px;"></p>
        <div>
        &nbsp;&nbsp;
        </div>
        &nbsp;&nbsp;
        <button class="green" id="Start">시작하기</button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button class="red" id="Stop">종료하기</button>
    </div>
    
    <script type="text/javascript" src="ggwave.js"></script>
    <script type='text/javascript'>
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        window.OfflineAudioContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;

        var context = null;
        var recorder = null;

        var ggwave = null;
        var parameters = null;
        var instance = null;

        ggwave_factory().then(function(obj) {
            ggwave = obj;
        });

        var status = document.getElementById("status");
        var result = document.getElementById("result");
        var Start = document.getElementById("Start");
        var Stop = document.getElementById("Stop");

        function convertTypedArray(src, type) {
            var buffer = new ArrayBuffer(src.byteLength);
            var baseView = new src.constructor(buffer).set(src);
            return new type(buffer);
        }

        function init() {
            if (!context) {
                context = new AudioContext({
                    sampleRate: 48000
                });

                parameters = ggwave.getDefaultParameters();
                parameters.sampleRateInp = context.sampleRate;
                parameters.sampleRateOut = context.sampleRate;
                instance = ggwave.init(parameters);
            }
        }
    </script>
    <script>
        Start.addEventListener('click', function() {
            Start.value = "시작하기";
            Stop.value = "안내가 종료되었습니다";
            init();

            let constraints = {
                audio: {
                    // not sure if these are necessary to have
                    echoCancellation: false,
                    autoGainControl: false,
                    noiseSuppression: false
                }
            };

            navigator.mediaDevices.getUserMedia(constraints).then(function(e) {
                mediaStream = context.createMediaStreamSource(e);

                var bufferSize = 16 * 1024;
                var numberOfInputChannels = 1;
                var numberOfOutputChannels = 1;

                if (context.createScriptProcessor) {
                    recorder = context.createScriptProcessor(
                        bufferSize,
                        numberOfInputChannels,
                        numberOfOutputChannels);
                } else {
                    recorder = context.createJavaScriptNode(
                        bufferSize,
                        numberOfInputChannels,
                        numberOfOutputChannels);
                }

                recorder.onaudioprocess = function(e) {
                    var source = e.inputBuffer;
                    var res = ggwave.decode(instance, convertTypedArray(new Float32Array(source.getChannelData(0)), Int8Array));
                    if (res) {
                        
                        result.innerText = res;
                    }
                }

                mediaStream.connect(recorder);
                recorder.connect(context.destination);
            }).catch(function(e) {
                console.error(e);
            });

            status.innerText = '음파 신호를 찾는 중입니다...';
            Start.value = "안내가 시작되었습니다";
            Stop.value = "종료하기";
        });

        Stop.addEventListener("click", function() {
            Start.value = "시작하기";
            Stop.value = "안내가 종료되었습니다";
            if (recorder) {
                recorder.disconnect(context.destination);
                mediaStream.disconnect(recorder);
                recorder = null;
            }

            status.innerText = '안내 중이 아닙니다. 안내를 원하시면 시작을 누르시거나, 마이크 권한 설정을 확인하십시오.';
        });

        captureStop.click();
    </script>
</body>

</html>

